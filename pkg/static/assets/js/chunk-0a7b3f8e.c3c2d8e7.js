(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-0a7b3f8e"],{"29e5":function(e,t,n){"use strict";n.r(t);var a=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("BasicLayout",{scopedSlots:e._u([{key:"wrapper",fn:function(){return[n("el-row",{staticClass:"mb10",attrs:{gutter:30}},[n("el-col",[n("el-card",{attrs:{shadow:"always"}},[n("el-button",{staticStyle:{"padding-left":"15px"},attrs:{type:"text"},on:{click:e.handleSendBatch}},[n("el-card",{staticClass:"box-card",staticStyle:{"background-color":"#9fe27e","align-items":"center"},attrs:{shadow:"always",align:"center"}},[n("i",{staticClass:"el-icon-s-promotion",staticStyle:{"font-size":"32px","margin-right":"10px"}}),n("span",{staticStyle:{"font-size":"24px"}},[e._v("发邮件")])])],1),n("el-button",{attrs:{type:"text"},on:{click:e.handleOpenSetting}},[n("el-card",{staticClass:"box-card",staticStyle:{"background-color":"#ced2da","align-items":"center"},attrs:{shadow:"always",align:"center"}},[n("i",{staticClass:"el-icon-setting",staticStyle:{"font-size":"32px","margin-right":"10px"}}),n("span",{staticStyle:{"font-size":"24px"}},[e._v("邮件发送配置")])])],1)],1)],1)],1),n("el-row",{attrs:{gutter:20}},[n("el-col",{attrs:{span:16}},[n("el-card",{staticClass:"box-card"},[n("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[n("span",[e._v("发送记录")])]),n("el-card",{staticClass:"box-card"},[n("el-form",{ref:"queryForm",attrs:{model:e.queryParams,inline:!0,"label-width":"100px"}},[n("el-form-item",{attrs:{label:"模板"}},[n("el-select",{attrs:{placeholder:"按模板筛选",clearable:"",size:"small"},model:{value:e.queryParams.template_id,callback:function(t){e.$set(e.queryParams,"template_id",t)},expression:"queryParams.template_id"}},e._l(e.templates,(function(e){return n("el-option",{key:e.id,attrs:{label:e.name,value:e.id}})})),1)],1),n("el-form-item",{attrs:{label:"客户邮箱"}},[n("el-input",{attrs:{placeholder:"请输入客户邮箱",clearable:"",size:"small"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleQuery(t)}},model:{value:e.queryParams.customer_email,callback:function(t){e.$set(e.queryParams,"customer_email",t)},expression:"queryParams.customer_email"}})],1),n("el-form-item",{attrs:{label:"发送结果状态"}},[n("el-select",{attrs:{placeholder:"发送状态",clearable:"",size:"small"},model:{value:e.queryParams.status,callback:function(t){e.$set(e.queryParams,"status",t)},expression:"queryParams.status"}},e._l(e.statusOptions,(function(e){return n("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1),n("el-form-item",[n("el-button",{attrs:{type:"primary",icon:"el-icon-search",size:"mini"},on:{click:e.handleQuery}},[e._v("搜索")]),n("el-button",{attrs:{icon:"el-icon-refresh",size:"mini"},on:{click:e.resetQuery}},[e._v("重置")])],1)],1),n("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{data:e.records,border:""}},[n("el-table-column",{attrs:{label:"模板",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.template.name)+" ")]}}])}),n("el-table-column",{attrs:{label:"客户",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.customer.email)+" ")]}}])}),n("el-table-column",{attrs:{label:"状态",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[2===t.row.status?n("el-popover",{attrs:{placement:"top-start",title:"失败原因",width:"200",trigger:"hover",content:t.row.reason}},[n("el-tag",{attrs:{slot:"reference",type:"danger","disable-transitions":""},slot:"reference"},[e._v("失败")])],1):e._e(),1===t.row.status?n("el-tag",{attrs:{type:"success","disable-transitions":""}},[e._v("成功")]):e._e()]}}])}),n("el-table-column",{attrs:{label:"创建时间",align:"center",prop:"created_at",width:"180"},scopedSlots:e._u([{key:"default",fn:function(t){return[n("span",[e._v(e._s(e.parseTime(t.row.created_at)))])]}}])}),n("el-table-column",{attrs:{label:"操作",align:"center","class-name":"small-padding fixed-width"},scopedSlots:e._u([{key:"default",fn:function(t){return[2===t.row.status?n("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-s-promotion"},on:{click:function(n){return e.handleReSend(t.row)}}},[e._v("重发")]):e._e(),n("el-button",{attrs:{size:"mini",type:"text",icon:"el-icon-delete"},on:{click:function(n){return e.handleDelete(t.row)}}},[e._v("删除")])]}}])})],1),n("pagination",{directives:[{name:"show",rawName:"v-show",value:e.total>0,expression:"total>0"}],attrs:{total:e.total,page:e.queryParams.pageIndex,limit:e.queryParams.pageSize},on:{"update:page":function(t){return e.$set(e.queryParams,"pageIndex",t)},"update:limit":function(t){return e.$set(e.queryParams,"pageSize",t)},pagination:e.getList}})],1)],1)],1),n("el-col",{attrs:{span:8}},[e.current?n("el-card",{staticClass:"box-card",attrs:{"body-style":{padding:"0"}}},[n("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[n("span",[e._v("当前任务")]),n("el-button",{staticStyle:{float:"right"},attrs:{type:"primary",plain:"",size:"small"},on:{click:e.handleCancelSend}},[e._v("结束当前任务")])],1),n("div",[n("p",[e._v("开始于: "+e._s(e.current.start_at))]),n("div",{staticClass:"tags"},[n("el-tag",{attrs:{size:"small"}},[e._v("总计("+e._s(e.current.total)+")")]),n("el-tag",{attrs:{size:"small",type:"success"}},[e._v("成功("+e._s(e.current.success)+")")]),n("el-tag",{attrs:{size:"small",type:"danger"}},[e._v("失败("+e._s(e.current.failure)+")")])],1),n("p",[e.current.error?n("el-tag",{attrs:{type:"danger"}},[e._v("任务失败: "+e._s(e.current.error))]):e._e()],1)]),n("el-progress",{attrs:{percentage:e.current.percentage}})],1):e._e()],1)],1),n("el-dialog",{attrs:{title:"邮件发送配置",visible:e.openSetting},on:{"update:visible":function(t){e.openSetting=t}}},[n("el-form",{ref:"setting",attrs:{model:e.cfg,rules:e.rules,"label-width":"100px"}},[n("el-form-item",{attrs:{label:"邮件服务器",prop:"host"}},[n("el-input",{attrs:{placeholder:"请输入邮件服务器地址"},model:{value:e.cfg.host,callback:function(t){e.$set(e.cfg,"host",t)},expression:"cfg.host"}})],1),n("el-form-item",{attrs:{label:"端口",prop:"port"}},[n("el-input-number",{attrs:{"controls-position":"right",placeholder:"请输入监听端口"},model:{value:e.cfg.port,callback:function(t){e.$set(e.cfg,"port",t)},expression:"cfg.port"}})],1),n("el-form-item",{attrs:{label:"用户名",prop:"username"}},[n("el-input",{attrs:{placeholder:"请输入用户名"},model:{value:e.cfg.username,callback:function(t){e.$set(e.cfg,"username",t)},expression:"cfg.username"}})],1),n("el-form-item",{attrs:{label:"密码",prop:"password"}},[n("el-input",{attrs:{placeholder:"请输入密码","show-password":""},model:{value:e.cfg.password,callback:function(t){e.$set(e.cfg,"password",t)},expression:"cfg.password"}})],1),n("el-form-item",{attrs:{label:"发送间隔(ms)",prop:"interval"}},[n("el-input-number",{attrs:{step:100,"controls-position":"right",placeholder:"请输入发送间隔时间"},model:{value:e.cfg.interval,callback:function(t){e.$set(e.cfg,"interval",t)},expression:"cfg.interval"}})],1)],1),n("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{attrs:{type:"primary"},on:{click:e.submitForm}},[e._v("确 定")]),n("el-button",{on:{click:e.cancel}},[e._v("取 消")])],1)],1),n("el-dialog",{attrs:{title:"发送邮件",visible:e.openSending},on:{"update:visible":function(t){e.openSending=t}}},[n("el-form",{ref:"sending",attrs:{model:e.sendBatch,rules:e.sendBatchRules,"label-width":"100px"}},[n("el-form-item",{attrs:{label:"使用模板",prop:"template_id"}},[n("el-select",{attrs:{placeholder:"请选择模板",clearable:"",size:"small"},model:{value:e.sendBatch.template_id,callback:function(t){e.$set(e.sendBatch,"template_id",t)},expression:"sendBatch.template_id"}},e._l(e.templates,(function(e){return n("el-option",{key:e.id,attrs:{label:e.name,value:e.id}})})),1)],1),n("el-form-item",{attrs:{label:"客户选择模式"}},[n("el-switch",{attrs:{"active-value":!0,"active-text":"包含","inactive-value":!1,"inactive-text":"排除"},model:{value:e.sendBatch.include,callback:function(t){e.$set(e.sendBatch,"include",t)},expression:"sendBatch.include"}})],1),n("el-form-item",{attrs:{label:"选择客户",prop:"customers"}},[n("el-select",{attrs:{multiple:"",filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入关键词","remote-method":e.findCustomers,loading:e.loading},model:{value:e.sendBatch.customer_ids,callback:function(t){e.$set(e.sendBatch,"customer_ids",t)},expression:"sendBatch.customer_ids"}},e._l(e.customers,(function(e){return n("el-option",{key:e.id,attrs:{label:e.email,value:e.id}})})),1)],1)],1),n("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{attrs:{type:"primary"},on:{click:e.doSend}},[e._v("开始发送")]),n("el-button",{on:{click:e.cancelSend}},[e._v("取 消")])],1)],1)]},proxy:!0}])})],1)},r=[],s=(n("7db0"),n("b775"));function i(e){return Object(s["a"])({url:"/api/v1/settings/"+e,method:"get"})}function o(e){return Object(s["a"])({url:"/api/v1/settings",method:"post",data:e})}function l(e){return Object(s["a"])({url:"/api/v1/records",method:"get",params:e})}function c(e){return Object(s["a"])({url:"/api/v1/records/"+e,method:"delete"})}var u=n("c621"),d=n("f6b0");function p(){return Object(s["a"])({url:"/api/v1/send-batches/current",method:"get"})}function m(e){return Object(s["a"])({url:"/api/v1/send-batches",method:"post",data:e})}function f(){return Object(s["a"])({url:"/api/v1/send-batches",method:"delete"})}var h={name:"SendManage",components:{},data:function(){return{queryParams:{pageIndex:1,pageSize:10,template_id:void 0,customer_email:void 0,status:void 0},loading:!1,total:0,records:[],templates:[],customers:[],openSetting:!1,cfg:{},statusOptions:[{label:"成功",value:1},{label:"失败",value:2}],rules:{host:[{required:!0,message:"邮件服务地址不能为空",trigger:"blur"}],port:[{required:!0,message:"邮件服务端口不能为空",trigger:"blur"}],username:[{required:!0,message:"邮件服务登录账号不能为空",trigger:"blur"}],password:[{required:!0,message:"邮件服务登录密码不能为空",trigger:"blur"}]},openSending:!1,sendBatch:{template_id:void 0,include:void 0,customer_ids:[]},sendBatchRules:{template_id:[{required:!0,message:"请选择模板",trigger:"blur"}]},current:void 0}},created:function(){this.getList(),this.loadTemplates(),this.loadCurrentTask()},methods:{getList:function(){var e=this;this.loading=!0,l(this.queryParams).then((function(t){e.records=t.list,e.total=t.pagination.total,e.loading=!1}))},loadTemplates:function(){var e=this;Object(u["d"])({pageSize:-1,lite:!0,status:1}).then((function(t){e.templates=t.list}))},loadCurrentTask:function(){var e=this;p().then((function(t){var n=t;if(n){n.total>0?n.percentage=(n.success+n.failure)/n.total*100:n.percentage=0,n.error||setTimeout((function(){e.loadCurrentTask()}),1e3);var a=e.current&&e.current.success||0;n.success-a>5&&e.getList()}e.current=n}))},loadSettings:function(){var e=this;return i("email_send_setting").then((function(t){var n=t&&t.value||{};return e.cfg=n,n}))},findCustomers:function(e){var t=this;""!==e?(this.loading=!0,Object(d["e"])({keyword:e,pageSize:10,status:1}).then((function(e){t.customers=e.list,t.loading=!1}))):this.customers=[]},handleQuery:function(){this.queryParams.pageIndex=1,this.getList()},resetQuery:function(){this.resetForm("queryForm"),this.handleQuery()},handleOpenSetting:function(){var e=this;this.loadSettings().then((function(){e.openSetting=!0}))},submitForm:function(){var e=this;this.$refs["setting"].validate((function(t){t&&o({key:"email_send_setting",value:e.cfg}).then((function(t){e.openSetting=!1}))}))},cancel:function(){this.openSetting=!1,this.reset()},reset:function(){this.cfg={host:void 0,port:void 0,username:void 0,password:void 0,interval:void 0},this.resetForm("setting")},handleSendBatch:function(){var e=this;this.loadSettings().then((function(t){t&&t.host?e.openSending=!0:e.$confirm("还未配置邮件服务器，是否现在开始配置?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.handleOpenSetting()}))}))},doSend:function(){var e=this;this.$refs["sending"].validate((function(t){t&&m(e.sendBatch).then((function(t){e.openSending=!1,e.loadCurrentTask()}))}))},cancelSend:function(){this.openSending=!1,this.resetSend()},resetSend:function(){this.sendBatch={template_id:void 0,include:void 0,customer_ids:[]},this.resetForm("sending")},handleDelete:function(e){this.$confirm("操作不可恢复，是否确认删除?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){var t=this;c(e.id).then((function(e){t.open=!1,t.getList()}))}))},handleReSend:function(e){this.sendBatch={template_id:e.template_id,include:!0,customer_ids:[e.customer_id]};var t=this.customers||[];t.find((function(t){return t.id===e.customer_id}))||t.push({id:e.customer.id,email:e.customer.email}),this.handleSendBatch()},handleCancelSend:function(){var e=this;this.current.error?f().then((function(t){e.loadCurrentTask()})):this.$confirm("当前发送任务还未完成，是否确定取消?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){return f()})).then((function(t){e.loadCurrentTask()}))}}},g=h,v=(n("4c01"),n("2877")),b=Object(v["a"])(g,a,r,!1,null,"76711c4a",null);t["default"]=b.exports},"3c0f":function(e,t,n){},"4c01":function(e,t,n){"use strict";n("3c0f")},"7db0":function(e,t,n){"use strict";var a=n("23e7"),r=n("b727").find,s=n("44d2"),i="find",o=!0;i in[]&&Array(1)[i]((function(){o=!1})),a({target:"Array",proto:!0,forced:o},{find:function(e){return r(this,e,arguments.length>1?arguments[1]:void 0)}}),s(i)},b775:function(e,t,n){"use strict";n("d3b7");var a=n("bc3a"),r=n.n(a),s=n("5c96"),i=r.a.create({baseURL:"",timeout:1e4});i.interceptors.request.use((function(e){return e.headers["Content-Type"]="application/json",e}),(function(e){return console.log(e),Promise.reject(e)})),i.interceptors.response.use((function(e){return e.data}),(function(e){var t=e.message;return e.response&&e.response.data&&e.response.data.error?t=e.response.data.error.message:"Network Error"===e.message&&(t="服务器连接异常，请检查服务器！"),console.log("err: "+e),Object(s["Message"])({message:t,type:"error",duration:5e3}),Promise.reject(e)})),t["a"]=i},c621:function(e,t,n){"use strict";n.d(t,"d",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return i})),n.d(t,"e",(function(){return o})),n.d(t,"b",(function(){return l}));var a=n("b775");function r(e){return Object(a["a"])({url:"/api/v1/templates",method:"get",params:e})}function s(e){return Object(a["a"])({url:"/api/v1/templates/"+e,method:"get"})}function i(e){return Object(a["a"])({url:"/api/v1/templates",method:"post",data:e})}function o(e,t){return Object(a["a"])({url:"/api/v1/templates/"+t,method:"put",data:e})}function l(e){return Object(a["a"])({url:"/api/v1/templates/"+e,method:"delete"})}},f6b0:function(e,t,n){"use strict";n.d(t,"e",(function(){return r})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return i})),n.d(t,"f",(function(){return o})),n.d(t,"b",(function(){return l})),n.d(t,"d",(function(){return c}));var a=n("b775");function r(e){return Object(a["a"])({url:"/api/v1/customers",method:"get",params:e})}function s(e){return Object(a["a"])({url:"/api/v1/customers/"+e,method:"get"})}function i(e){return Object(a["a"])({url:"/api/v1/customers",method:"post",data:e})}function o(e,t){return Object(a["a"])({url:"/api/v1/customers/"+t,method:"put",data:e})}function l(e){return Object(a["a"])({url:"/api/v1/customers/"+e,method:"delete"})}var c="/api/v1/customers/import"}}]);